// Prisma Schema for Modern ShortLink System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  role      Role     @default(USER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联的短链接
  links Link[]
  
  // 用户设置
  settings UserSettings?

  @@map("users")
}

// 用户角色枚举
enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

// 用户设置表
model UserSettings {
  id                String  @id @default(cuid())
  userId            String  @unique
  defaultDomain     String?
  customDomains     String[]
  enableAnalytics   Boolean @default(true)
  enableNotifications Boolean @default(true)
  apiKeyEnabled     Boolean @default(false)
  apiKey            String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}

// 短链接表
model Link {
  id          String     @id @default(cuid())
  shortCode   String     @unique
  originalUrl String
  title       String?
  description String?
  domain      String     @default("localhost")
  userId      String
  isActive    Boolean    @default(true)
  isPublic    Boolean    @default(true)
  expiresAt   DateTime?
  password    String?    // 访问密码
  maxClicks   Int?       // 最大点击次数
  tags        String[]   // 标签
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // 关联用户
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 访问记录
  clicks Click[]
  
  // 统计数据
  stats LinkStats?

  @@map("links")
}

// 点击记录表
model Click {
  id        String   @id @default(cuid())
  linkId    String
  ip        String
  userAgent String?
  referer   String?
  country   String?
  city      String?
  device    String?
  browser   String?
  os        String?
  createdAt DateTime @default(now())

  // 关联短链接
  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@map("clicks")
}

// 链接统计表
model LinkStats {
  id            String   @id @default(cuid())
  linkId        String   @unique
  totalClicks   Int      @default(0)
  uniqueClicks  Int      @default(0)
  lastClickAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关联短链接
  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@map("link_stats")
}

// 系统设置表
model SystemSettings {
  id                    String   @id @default(cuid())
  siteName              String   @default("Modern ShortLink")
  siteDescription       String   @default("现代化短链接系统")
  defaultDomain         String   @default("localhost")
  allowRegistration     Boolean  @default(true)
  requireEmailVerification Boolean @default(false)
  maxLinksPerUser       Int      @default(1000)
  defaultLinkExpiration Int?     // 默认过期时间（天）
  enableAnalytics       Boolean  @default(true)
  enableRateLimit       Boolean  @default(true)
  rateLimitMax          Int      @default(100)
  rateLimitWindow       Int      @default(900000) // 15分钟
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("system_settings")
}

// API密钥表
model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  name      String
  key       String   @unique
  isActive  Boolean  @default(true)
  lastUsed  DateTime?
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("api_keys")
}
